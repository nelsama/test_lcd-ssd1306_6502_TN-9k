# Makefile para Demo Features SSD1306 (sin framebuffer)
# Texto, Números, BigFont, Gráficos, Scroll, Control
# ROM: ~6 KB | RAM: ~0 bytes

# ============================================
# DIRECTORIOS
# ============================================
SRC_DIR = src
LIB_DIR = libs
BUILD_DIR = build
OUTPUT_DIR = output
CONFIG_DIR = config

# ============================================
# HERRAMIENTAS
# ============================================
CL65 = cl65
CA65 = ca65
LD65 = ld65
PYTHON = py

# ============================================
# CONFIGURACIÓN
# ============================================
CONFIG = $(CONFIG_DIR)/fpga.cfg
PLATAFORMA = D:\cc65\lib\none.lib
CFLAGS = -t none -O --cpu 6502

# ============================================
# INCLUDES - Config local ANTES de libs
# ============================================
UART_DIR = $(LIB_DIR)\uart
I2C_DIR = $(LIB_DIR)\i2c
SSD1306_DIR = $(LIB_DIR)\ssd1306
SSD1306_CONFIG = $(CONFIG_DIR)\ssd1306_config_features.h
INCLUDES = -I$(CONFIG_DIR) -I$(LIB_DIR)

# ============================================
# ARCHIVOS OBJETO
# ============================================
MAIN_OBJ = $(BUILD_DIR)/main_features_demo.o
UART_OBJ = $(BUILD_DIR)/uart.o
I2C_OBJ = $(BUILD_DIR)/i2c.o
STARTUP_OBJ = $(BUILD_DIR)/startup.o
VECTORS_OBJ = $(BUILD_DIR)/simple_vectors.o

# SSD1306 - Features (sin framebuffer)
SSD1306_OBJS = \
    $(BUILD_DIR)/ssd1306_core.o \
    $(BUILD_DIR)/ssd1306_control.o \
    $(BUILD_DIR)/font_5x7_full.o \
    $(BUILD_DIR)/ssd1306_text.o \
    $(BUILD_DIR)/ssd1306_numbers.o \
    $(BUILD_DIR)/ssd1306_bigfont.o \
    $(BUILD_DIR)/ssd1306_graphics.o \
    $(BUILD_DIR)/ssd1306_scroll.o

OBJS = $(MAIN_OBJ) $(UART_OBJ) $(I2C_OBJ) $(STARTUP_OBJ) $(VECTORS_OBJ) $(SSD1306_OBJS)

# ============================================
# TARGET
# ============================================
TARGET = $(BUILD_DIR)/main_features_demo.bin

all: dirs config
	@$(MAKE) -f makefile_features_demo build_and_rom

build_and_rom: $(TARGET) rom
	@echo ========================================
	@echo FEATURES DEMO - COMPILADO
	@echo ========================================

dirs:
	@if not exist "$(BUILD_DIR)" mkdir "$(BUILD_DIR)"
	@if not exist "$(OUTPUT_DIR)" mkdir "$(OUTPUT_DIR)"

config:
	@if not exist "$(CONFIG_DIR)\ssd1306" mkdir "$(CONFIG_DIR)\ssd1306"
	@xcopy /Y /Q "$(SSD1306_CONFIG)" "$(CONFIG_DIR)\ssd1306\ssd1306_config.h*" >nul

# ============================================
# LINKER
# ============================================
$(TARGET): $(OBJS)
	$(LD65) -C $(CONFIG) -o $@ $(OBJS) $(PLATAFORMA)
	@echo ROM size:
	@powershell -Command "(Get-Item $@).Length"

# ============================================
# CONVERSIÓN A VHDL
# ============================================
rom: $(TARGET)
	$(PYTHON) scripts/bin2rom3.py $(TARGET) -s 8192 -o $(OUTPUT_DIR)

# ============================================
# COMPILACIÓN - Todos los .o que usan ssd1306 dependen de config
# ============================================
$(BUILD_DIR)/main_features_demo.o: $(SRC_DIR)/main_features_demo.c | config
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/uart.o: $(UART_DIR)/uart.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/i2c.o: $(I2C_DIR)/i2c.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/startup.o: $(SRC_DIR)/startup.s
	$(CA65) --cpu 6502 -o $@ $<

$(BUILD_DIR)/simple_vectors.o: $(SRC_DIR)/simple_vectors.s
	$(CA65) --cpu 6502 -o $@ $<

# SSD1306 módulos
$(BUILD_DIR)/ssd1306_core.o: $(SSD1306_DIR)/core/ssd1306_core.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_control.o: $(SSD1306_DIR)/core/ssd1306_control.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/font_5x7_full.o: $(SSD1306_DIR)/fonts/font_5x7_full.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_text.o: $(SSD1306_DIR)/text/ssd1306_text.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_numbers.o: $(SSD1306_DIR)/numbers/ssd1306_numbers.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_bigfont.o: $(SSD1306_DIR)/bignum/ssd1306_bigfont.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_bignum.o: $(SSD1306_DIR)/bignum/ssd1306_bignum.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_graphics.o: $(SSD1306_DIR)/graphics/ssd1306_graphics.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/ssd1306_scroll.o: $(SSD1306_DIR)/scroll/ssd1306_scroll.c
	$(CL65) $(CFLAGS) $(INCLUDES) -c -o $@ $<

# ============================================
# LIMPIEZA
# ============================================
clean:
	@if exist "$(BUILD_DIR)\*.o" del /Q "$(BUILD_DIR)\*.o"
	@if exist "$(BUILD_DIR)\*.bin" del /Q "$(BUILD_DIR)\*.bin"
	@if exist "$(CONFIG_DIR)\ssd1306" rmdir /S /Q "$(CONFIG_DIR)\ssd1306"

.PHONY: all dirs config rom clean
